!function(a,b){"object"==typeof exports?(a.sf2=exports,b(exports)):"function"==typeof define&&define.amd?define(["exports"],function(c){return a.sf2=c,a.sf2,b(c)}):(a.sf2={},b(a.sf2))}(this,function(a){"use strict";var b=a;return b.Parser=function(a,b){b=b||{},this.input=a,this.parserOptions=b.parserOptions},b.Parser.prototype.parse=function(){var a,c=new b.Riff.Parser(this.input,this.parserOptions);if(c.parse(),1!==c.chunkList.length)throw new Error("wrong chunk length");if(a=c.getChunk(0),null===a)throw new Error("chunk not found");this.parseRiffChunk(a),this.input=null},b.Parser.prototype.parseRiffChunk=function(a){var c,d,e=this.input,f=a.offset;if("RIFF"!==a.type)throw new Error("invalid chunk type:"+a.type);if(d=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]),"sfbk"!==d)throw new Error("invalid signature:"+d);if(c=new b.Riff.Parser(e,{index:f,length:a.size-4}),c.parse(),3!==c.getNumberOfChunks())throw new Error("invalid sfbk structure");this.parseInfoList(c.getChunk(0)),this.parseSdtaList(c.getChunk(1)),this.parsePdtaList(c.getChunk(2))},b.Parser.prototype.parseInfoList=function(a){var c,d,e=this.input,f=a.offset;if("LIST"!==a.type)throw new Error("invalid chunk type:"+a.type);if(d=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]),"INFO"!==d)throw new Error("invalid signature:"+d);c=new b.Riff.Parser(e,{index:f,length:a.size-4}),c.parse()},b.Parser.prototype.parseSdtaList=function(a){var c,d,e=this.input,f=a.offset;if("LIST"!==a.type)throw new Error("invalid chunk type:"+a.type);if(d=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]),"sdta"!==d)throw new Error("invalid signature:"+d);if(c=new b.Riff.Parser(e,{index:f,length:a.size-4}),c.parse(),1!==c.chunkList.length)throw new Error("TODO");this.samplingData=c.getChunk(0)},b.Parser.prototype.parsePdtaList=function(a){var c,d,e=this.input,f=a.offset;if("LIST"!==a.type)throw new Error("invalid chunk type:"+a.type);if(d=String.fromCharCode(e[f++],e[f++],e[f++],e[f++]),"pdta"!==d)throw new Error("invalid signature:"+d);if(c=new b.Riff.Parser(e,{index:f,length:a.size-4}),c.parse(),9!==c.getNumberOfChunks())throw new Error("invalid pdta chunk");this.parsePhdr(c.getChunk(0)),this.parsePbag(c.getChunk(1)),this.parsePmod(c.getChunk(2)),this.parsePgen(c.getChunk(3)),this.parseInst(c.getChunk(4)),this.parseIbag(c.getChunk(5)),this.parseImod(c.getChunk(6)),this.parseIgen(c.getChunk(7)),this.parseShdr(c.getChunk(8))},b.Parser.prototype.parsePhdr=function(a){var b=this.input,c=a.offset,d=this.presetHeader=[],e=a.offset+a.size;if("phdr"!==a.type)throw new Error("invalid chunk type:"+a.type);for(;e>c;)d.push({presetName:String.fromCharCode.apply(null,b.subarray(c,c+=20)),preset:b[c++]|b[c++]<<8,bank:b[c++]|b[c++]<<8,presetBagIndex:b[c++]|b[c++]<<8,library:(b[c++]|b[c++]<<8|b[c++]<<16|b[c++]<<24)>>>0,genre:(b[c++]|b[c++]<<8|b[c++]<<16|b[c++]<<24)>>>0,morphology:(b[c++]|b[c++]<<8|b[c++]<<16|b[c++]<<24)>>>0})},b.Parser.prototype.parsePbag=function(a){var b=this.input,c=a.offset,d=this.presetZone=[],e=a.offset+a.size;if("pbag"!==a.type)throw new Error("invalid chunk type:"+a.type);for(;e>c;)d.push({presetGeneratorIndex:b[c++]|b[c++]<<8,presetModulatorIndex:b[c++]|b[c++]<<8})},b.Parser.prototype.parsePmod=function(a){if("pmod"!==a.type)throw new Error("invalid chunk type:"+a.type);this.presetZoneModulator=this.parseModulator(a)},b.Parser.prototype.parsePgen=function(a){if("pgen"!==a.type)throw new Error("invalid chunk type:"+a.type);this.presetZoneGenerator=this.parseGenerator(a)},b.Parser.prototype.parseInst=function(a){var b=this.input,c=a.offset,d=this.instrument=[],e=a.offset+a.size;if("inst"!==a.type)throw new Error("invalid chunk type:"+a.type);for(;e>c;)d.push({instrumentName:String.fromCharCode.apply(null,b.subarray(c,c+=20)),instrumentBagIndex:b[c++]|b[c++]<<8})},b.Parser.prototype.parseIbag=function(a){var b=this.input,c=a.offset,d=this.instrumentZone=[],e=a.offset+a.size;if("ibag"!==a.type)throw new Error("invalid chunk type:"+a.type);for(;e>c;)d.push({instrumentGeneratorIndex:b[c++]|b[c++]<<8,instrumentModulatorIndex:b[c++]|b[c++]<<8})},b.Parser.prototype.parseImod=function(a){if("imod"!==a.type)throw new Error("invalid chunk type:"+a.type);this.instrumentZoneModulator=this.parseModulator(a)},b.Parser.prototype.parseIgen=function(a){if("igen"!==a.type)throw new Error("invalid chunk type:"+a.type);this.instrumentZoneGenerator=this.parseGenerator(a)},b.Parser.prototype.parseShdr=function(a){var b,c,d,e,f,g,h,i,j,k,l=this.input,m=a.offset,n=this.sample=[],o=this.sampleHeader=[],p=a.offset+a.size;if("shdr"!==a.type)throw new Error("invalid chunk type:"+a.type);for(;p>m;){b=String.fromCharCode.apply(null,l.subarray(m,m+=20)),c=(l[m++]<<0|l[m++]<<8|l[m++]<<16|l[m++]<<24)>>>0,d=(l[m++]<<0|l[m++]<<8|l[m++]<<16|l[m++]<<24)>>>0,e=(l[m++]<<0|l[m++]<<8|l[m++]<<16|l[m++]<<24)>>>0,f=(l[m++]<<0|l[m++]<<8|l[m++]<<16|l[m++]<<24)>>>0,g=(l[m++]<<0|l[m++]<<8|l[m++]<<16|l[m++]<<24)>>>0,h=l[m++],i=l[m++]<<24>>24,j=l[m++]|l[m++]<<8,k=l[m++]|l[m++]<<8;var q=new Int16Array(new Uint8Array(l.subarray(this.samplingData.offset+2*c,this.samplingData.offset+2*d)).buffer);if(e-=c,f-=c,g>0){var r=this.adjustSampleData(q,g);q=r.sample,g*=r.multiply,e*=r.multiply,f*=r.multiply}n.push(q),o.push({sampleName:b,startLoop:e,endLoop:f,sampleRate:g,originalPitch:h,pitchCorrection:i,sampleLink:j,sampleType:k})}},b.Parser.prototype.adjustSampleData=function(a,b){for(var c,d,e,f,g=1;22050>b;){for(c=new Int16Array(2*a.length),d=f=0,e=a.length;e>d;++d)c[f++]=a[d],c[f++]=a[d];a=c,g*=2,b*=2}return{sample:a,multiply:g}},b.Parser.prototype.parseModulator=function(a){for(var c,d,e=this.input,f=a.offset,g=a.offset+a.size,h=[];g>f;){if(f+=2,c=e[f++]|e[f++]<<8,d=b.Parser.GeneratorEnumeratorTable[c],void 0===d)h.push({type:d,value:{code:c,amount:e[f]|e[f+1]<<8<<16>>16,lo:e[f++],hi:e[f++]}});else switch(d){case"keyRange":case"velRange":case"keynum":case"velocity":h.push({type:d,value:{lo:e[f++],hi:e[f++]}});break;default:h.push({type:d,value:{amount:e[f++]|e[f++]<<8<<16>>16}})}f+=2,f+=2}return h},b.Parser.prototype.parseGenerator=function(a){for(var c,d,e=this.input,f=a.offset,g=a.offset+a.size,h=[];g>f;)if(c=e[f++]|e[f++]<<8,d=b.Parser.GeneratorEnumeratorTable[c],void 0!==d)switch(d){case"keynum":case"keyRange":case"velRange":case"velocity":h.push({type:d,value:{lo:e[f++],hi:e[f++]}});break;default:h.push({type:d,value:{amount:e[f++]|e[f++]<<8<<16>>16}})}else h.push({type:d,value:{code:c,amount:e[f]|e[f+1]<<8<<16>>16,lo:e[f++],hi:e[f++]}});return h},b.Parser.prototype.getInstruments=function(){var a,b,c,d,e,f,g,h,i,j=this.instrument,k=this.instrumentZone,l=[];for(f=0,g=j.length;g>f;++f){for(a=j[f].instrumentBagIndex,b=j[f+1]?j[f+1].instrumentBagIndex:k.length,c=[],h=a,i=b;i>h;++h)d=this.createInstrumentGenerator_(k,h),e=this.createInstrumentModulator_(k,h),c.push({generator:d.generator,generatorSequence:d.generatorInfo,modulator:e.modulator,modulatorSequence:e.modulatorInfo});l.push({name:j[f].instrumentName,info:c})}return l},b.Parser.prototype.getPresets=function(){var a,b,c,d,e,f,g,h,i,j,k=this.presetHeader,l=this.presetZone,m=[];for(g=0,h=k.length;h>g;++g){for(a=k[g].presetBagIndex,b=k[g+1]?k[g+1].presetBagIndex:l.length,c=[],i=a,j=b;j>i;++i)e=this.createPresetGenerator_(l,i),f=this.createPresetModulator_(l,i),c.push({generator:e.generator,generatorSequence:e.generatorInfo,modulator:f.modulator,modulatorSequence:f.modulatorInfo}),d=void 0!==e.generator.instrument?e.generator.instrument.amount:void 0!==f.modulator.instrument?f.modulator.instrument.amount:null;m.push({name:k[g].presetName,info:c,header:k[g],instrument:d})}return m},b.Parser.prototype.createInstrumentGenerator_=function(a,b){var c=this.createBagModGen_(a,a[b].instrumentGeneratorIndex,a[b+1]?a[b+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length,this.instrumentZoneGenerator);return{generator:c.modgen,generatorInfo:c.modgenInfo}},b.Parser.prototype.createInstrumentModulator_=function(a,b){var c=this.createBagModGen_(a,a[b].presetModulatorIndex,a[b+1]?a[b+1].instrumentModulatorIndex:this.instrumentZoneModulator.length,this.instrumentZoneModulator);return{modulator:c.modgen,modulatorInfo:c.modgenInfo}},b.Parser.prototype.createPresetGenerator_=function(a,b){var c=this.createBagModGen_(a,a[b].presetGeneratorIndex,a[b+1]?a[b+1].presetGeneratorIndex:this.presetZoneGenerator.length,this.presetZoneGenerator);return{generator:c.modgen,generatorInfo:c.modgenInfo}},b.Parser.prototype.createPresetModulator_=function(a,b){var c=this.createBagModGen_(a,a[b].presetModulatorIndex,a[b+1]?a[b+1].presetModulatorIndex:this.presetZoneModulator.length,this.presetZoneModulator);return{modulator:c.modgen,modulatorInfo:c.modgenInfo}},b.Parser.prototype.createBagModGen_=function(a,b,c,d){var e,f,g,h=[],i={unknown:[],keyRange:{hi:127,lo:0}};for(f=b,g=c;g>f;++f)e=d[f],h.push(e),"unknown"===e.type?i.unknown.push(e.value):i[e.type]=e.value;return{modgen:i,modgenInfo:h}},b.Parser.GeneratorEnumeratorTable=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",void 0,"chorusEffectsSend","reverbEffectsSend","pan",void 0,void 0,void 0,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay","delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",void 0,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",void 0,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",void 0,"scaleTuning","exclusiveClass","overridingRootKey"],b.Riff={},b.Riff.Parser=function(a,b){b=b||{},this.input=a,this.ip=b.index||0,this.length=b.length||a.length-this.ip,this.offset=this.ip,this.padding=void 0!==b.padding?b.padding:!0,this.bigEndian=void 0!==b.bigEndian?b.bigEndian:!1},b.Riff.Chunk=function(a,b,c){this.type=a,this.size=b,this.offset=c},b.Riff.Parser.prototype.parse=function(){var a=this.length+this.offset;for(this.chunkList=[];this.ip<a;)this.parseChunk()},b.Riff.Parser.prototype.parseChunk=function(){var a,c=this.input,d=this.ip;this.chunkList.push(new b.Riff.Chunk(String.fromCharCode(c[d++],c[d++],c[d++],c[d++]),a=this.bigEndian?(c[d++]<<24|c[d++]<<16|c[d++]<<8|c[d++])>>>0:(c[d++]|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,d)),d+=a,this.padding&&1===(d-this.offset&1)&&d++,this.ip=d},b.Riff.Parser.prototype.getChunk=function(a){var b=this.chunkList[a];return void 0===b?null:b},b.Riff.Parser.prototype.getNumberOfChunks=function(){return this.chunkList.length},b});